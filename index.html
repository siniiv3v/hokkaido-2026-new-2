
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hokkaido Trip (Final)</title>
    
    <!-- 核心函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;500;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">

    <!-- Tailwind 設定 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Zen Maru Gothic"', '"Noto Sans TC"', 'sans-serif'],
                        mono: ['"Oswald"', 'monospace'] 
                    },
                    colors: {
                        muji: {
                            bg: '#F9F9F7',
                            card: '#FFFFFF',
                            text: '#44403C',
                            sub: '#78716C',
                            accent: '#8DA3C1',
                            warm: '#E7E5E4',
                        }
                    },
                    boxShadow: {
                        'soft': '0 10px 30px -10px rgba(68, 64, 60, 0.08)',
                        'float': '0 20px 40px -10px rgba(68, 64, 60, 0.12)',
                    },
                    spacing: { 'safe-top': 'env(safe-area-inset-top)', 'safe-bottom': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F9F9F7; color: #44403C; -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea { user-select: text; outline: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass { background: rgba(249, 249, 247, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        [v-cloak] { display: none; }
        /* 同步狀態指示燈 */
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .sync-online { background-color: #4ade80; box-shadow: 0 0 8px #4ade80; }
        .sync-offline { background-color: #ef4444; }
        .sync-saving { background-color: #fbbf24; animation: pulse 1s infinite; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-muji-text">

<div id="app" v-cloak class="flex flex-col h-full relative">
    
    <!-- 登入遮罩 -->
    <div v-if="!user" class="fixed inset-0 z-[100] bg-[#F9F9F7] flex flex-col items-center justify-center p-6 text-center fade-in">
        <div class="mb-8 relative">
            <i class="fa-regular fa-snowflake text-6xl text-muji-accent animate-pulse"></i>
            <i class="fa-solid fa-plane absolute -bottom-2 -right-2 text-2xl text-stone-400"></i>
        </div>
        <h1 class="text-2xl font-bold text-muji-text mb-2 tracking-widest">HOKKAIDO TRIP</h1>
        <p class="text-stone-400 text-sm mb-10">請登入以同步行程資料</p>
        <button @click="login" class="bg-white border border-stone-200 shadow-float px-8 py-4 rounded-[1.5rem] flex items-center gap-3 active:scale-95 transition-transform hover:border-muji-accent">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
            <span class="font-bold text-stone-600">使用 Google 登入</span>
        </button>
        <p class="mt-8 text-[10px] text-stone-300">安全連線由 Google Firebase 提供</p>
    </div>

    <!-- Header -->
    <header class="glass z-30 pt-safe-top border-b border-stone-200/50 absolute top-0 w-full shadow-sm flex flex-col">
        <div class="h-12 flex items-center justify-center shrink-0 relative">
            <h1 class="text-xl font-bold tracking-widest flex items-center gap-2">
                Hokkaido <i class="fa-regular fa-snowflake text-muji-accent text-2xl animate-pulse"></i>
            </h1>
            <div class="absolute right-4 top-1/2 -translate-y-1/2 flex items-center">
                <div :class="syncStatusClass" class="sync-dot transition-colors"></div>
            </div>
        </div>
        <nav class="flex w-full overflow-x-auto hide-scrollbar px-2 pb-0">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" 
                class="flex-1 min-w-[4rem] flex flex-col items-center justify-center pb-2 pt-1 gap-1 relative transition-colors group"
                :class="currentTab === tab.id ? 'text-muji-text' : 'text-stone-300 hover:text-stone-400'">
                <i :class="tab.icon" class="text-lg transition-transform duration-300" :class="currentTab === tab.id ? '-translate-y-0.5' : ''"></i>
                <span class="text-[10px] font-bold tracking-wide">{{ tab.name }}</span>
                <div class="absolute bottom-0 w-8 h-1 bg-muji-accent rounded-t-full transition-all duration-300" :class="currentTab === tab.id ? 'opacity-100 scale-100' : 'opacity-0 scale-0'"></div>
            </button>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto hide-scrollbar pt-28 pb-safe-bottom px-5 bg-muji-bg">
        
        <!-- 1. 資訊 (Info) -->
        <div v-if="currentTab === 'info'" class="fade-in space-y-6 pb-20">
            <!-- 天氣 -->
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2 bg-gradient-to-br from-[#A5B4C4] to-[#7990B0] rounded-[2rem] p-5 text-white shadow-soft relative overflow-hidden group">
                    <div class="relative z-10 flex justify-between items-start mb-4">
                        <div>
                            <p class="text-[10px] font-medium opacity-80 uppercase tracking-widest mb-1"><i class="fa-solid fa-location-dot mr-1"></i>Sapporo</p>
                            <h3 class="text-5xl font-bold tracking-tight">{{ weather.current.temp }}<span class="text-2xl align-top">°</span></h3>
                            <div class="flex items-center gap-2 mt-1 opacity-90 text-xs">
                                <span class="capitalize">{{ weather.current.desc }}</span>
                                <span class="w-1 h-1 bg-white rounded-full opacity-50"></span>
                                <span>體感 {{ weather.current.feelsLike }}°</span>
                            </div>
                        </div>
                        <div class="text-right">
                             <i :class="weather.current.icon" class="text-5xl drop-shadow-md opacity-90"></i>
                             <p class="text-[10px] mt-2 opacity-70">更新於 {{ weather.lastUpdate }}</p>
                        </div>
                    </div>
                    <div class="w-full h-px bg-white/20 mb-3"></div>
                    <div class="relative z-10 grid grid-cols-3 gap-2">
                        <div v-for="(day, idx) in weather.forecast" :key="idx" class="flex flex-col items-center justify-between p-2 rounded-xl bg-white/10 backdrop-blur-sm border border-white/5">
                            <span class="text-[10px] font-bold opacity-80">{{ day.date }}</span>
                            <i :class="day.icon" class="text-xl my-1.5 opacity-90"></i>
                            <div class="flex gap-1 text-[10px] font-bold">
                                <span class="opacity-100">{{ day.max }}°</span>
                                <span class="opacity-60">{{ day.min }}°</span>
                            </div>
                        </div>
                    </div>
                    <i :class="weather.current.icon" class="absolute -top-6 -right-6 text-[10rem] opacity-5 rotate-12 z-0"></i>
                </div>
                <!-- 匯率 -->
                <div class="col-span-2 bg-white rounded-[2rem] p-5 shadow-soft relative border border-stone-50 flex items-center justify-between">
                    <div>
                        <p class="text-[10px] text-stone-400 font-bold uppercase tracking-widest">Rate (HKD)</p>
                        <div class="flex items-baseline mt-1">
                            <span class="text-stone-300 text-sm mr-2">¥</span>
                            <input type="number" v-model="exchangeInput" class="w-24 bg-transparent font-bold text-2xl text-stone-700 placeholder-stone-200 border-b border-stone-100 focus:border-muji-accent transition-colors pb-1">
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="block text-3xl font-bold text-stone-700">${{ (exchangeInput * exchangeRate).toFixed(1) }}</span>
                        <span class="text-[10px] text-stone-400">即時匯率 {{ Number(exchangeRate).toFixed(4) }}</span>
                    </div>
                </div>
            </div>

            <!-- 住宿 -->
            <div class="space-y-4">
                <div class="flex justify-between items-end px-1">
                    <h2 class="text-sm font-bold text-muji-text border-l-4 border-muji-accent pl-2">住宿安排</h2>
                    <button @click="openHotelModal(false)" class="text-xs text-stone-400 bg-white border border-stone-200 px-3 py-1.5 rounded-full shadow-sm active:scale-90 transition-transform"><i class="fa-solid fa-plus mr-1"></i>新增</button>
                </div>
                <div v-if="hotels.length === 0" class="text-center py-8 bg-white/50 rounded-[2rem] border-2 border-dashed border-stone-200"><p class="text-xs text-stone-400">尚未新增住宿</p></div>
                <div v-for="(hotel, idx) in hotels" :key="hotel.id" @click="openHotelModal(true, hotel)" class="bg-white rounded-[2rem] shadow-soft overflow-hidden group active:scale-[0.99] transition-transform cursor-pointer">
                    <div class="h-32 bg-stone-200 relative">
                        <img v-if="hotel.image" :src="hotel.image" class="w-full h-full object-cover">
                        <div v-else class="w-full h-full flex items-center justify-center text-stone-400 flex-col"><i class="fa-solid fa-hotel text-2xl mb-1"></i><span class="text-[10px]">無照片</span></div>
                        <div class="absolute top-3 right-3 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-bold shadow-sm">¥ {{ Number(hotel.price).toLocaleString() }} <span class="text-[10px] text-stone-400 font-normal">/總價</span></div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-bold text-lg text-muji-text leading-tight mb-1">{{ hotel.name }}</h3>
                        <div v-if="hotel.startDate" class="flex items-center gap-2 mb-2">
                             <span class="bg-stone-800 text-white text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm">{{ calculateNights(hotel.startDate, hotel.endDate) }} 晚</span>
                             <span class="text-xs text-stone-500 font-bold font-sans">{{ hotel.startDate.replace(/-/g, '/') }} ~ {{ hotel.endDate ? hotel.endDate.replace(/-/g, '/') : '?' }}</span>
                        </div>
                        <p class="text-xs text-stone-400 mb-3"><i class="fa-solid fa-map-pin mr-1 text-muji-accent"></i>{{ hotel.address || '未填寫地址' }}</p>
                        <div class="flex items-center justify-between bg-stone-50 rounded-xl p-3 mb-3">
                            <div class="text-center"><p class="text-[10px] text-stone-400 uppercase">Check-in</p><p class="font-bold text-sm">{{ hotel.checkIn }}</p></div>
                            <i class="fa-solid fa-arrow-right text-stone-200 text-xs"></i>
                            <div class="text-center"><p class="text-[10px] text-stone-400 uppercase">Check-out</p><p class="font-bold text-sm">{{ hotel.checkOut }}</p></div>
                        </div>
                        <div class="flex items-center justify-between border-t border-stone-100 pt-3">
                            <span class="text-xs text-stone-400 font-bold">每人分攤 ({{ members.length }}人)</span>
                            <span class="text-lg font-bold text-muji-text">¥ {{ (hotel.price / (members.length || 1)).toLocaleString(undefined, {maximumFractionDigits:0}) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 航班 -->
            <div>
                 <div class="flex justify-between items-end px-1 mb-3">
                     <h2 class="text-sm font-bold text-muji-text border-l-4 border-stone-300 pl-2">航班資訊</h2>
                     <button @click="openFlightModal()" class="text-xs text-stone-400 bg-white border border-stone-200 px-3 py-1.5 rounded-full shadow-sm active:scale-90 transition-transform"><i class="fa-solid fa-plus mr-1"></i>新增</button>
                 </div>
                 <div v-if="flights.length === 0" class="text-center py-8 bg-white/50 rounded-[2rem] border-2 border-dashed border-stone-200"><p class="text-xs text-stone-400">尚未新增航班</p></div>
                 <div v-for="(flight, idx) in flights" :key="idx" 
                      @click="openFlightModal(flight, idx)"
                      class="bg-white rounded-[1.5rem] shadow-float overflow-hidden mb-4 relative group active:scale-[0.99] transition-transform cursor-pointer border border-stone-100/50">
                     <div :class="flight.type === '去程' ? 'bg-muji-accent/20 text-blue-800' : 'bg-orange-100 text-orange-800'" class="px-5 py-2 flex justify-between items-center">
                         <div class="flex items-center gap-2">
                             <span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-white/60 backdrop-blur-sm">{{ flight.type }}</span>
                             <span class="text-xs font-bold tracking-wider opacity-80">{{ flight.flightNo || '未設定編號' }}</span>
                         </div>
                         <i class="fa-solid fa-plane-up transform rotate-45 opacity-20 text-xl"></i>
                     </div>
                     <div class="p-5 flex justify-between items-center relative">
                         <div class="text-center w-1/3">
                             <span class="block text-3xl font-black font-mono text-stone-700 leading-none mb-1">{{ flight.depCode }}</span>
                             <span class="text-sm font-bold text-muji-text">{{ flight.depTime }}</span>
                         </div>
                         <div class="flex-1 flex flex-col items-center justify-center px-2">
                             <div class="flex items-center gap-1 text-[10px] text-stone-400 font-medium bg-stone-50 px-2 py-0.5 rounded-full mb-1">
                                 <i class="fa-regular fa-clock"></i> {{ flight.duration }}
                             </div>
                             <div class="w-full h-px bg-stone-300 relative flex items-center justify-center">
                                 <i class="fa-solid fa-plane text-stone-300 text-xs absolute bg-white px-1"></i>
                             </div>
                         </div>
                         <div class="text-center w-1/3">
                             <span class="block text-3xl font-black font-mono text-stone-700 leading-none mb-1">{{ flight.arrCode }}</span>
                             <span class="text-sm font-bold text-muji-text">{{ flight.arrTime }}</span>
                             <span v-if="isNextDay(flight.depTime, flight.arrTime)" class="absolute top-6 right-4 text-[9px] text-red-400 font-bold">+1</span>
                         </div>
                     </div>
                     <div class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-stone-200 to-transparent opacity-50"></div>
                 </div>
            </div>
        </div>

        <!-- 2. 準備 (Planning) -->
        <div v-if="currentTab === 'planning'" class="fade-in space-y-6 pb-20">
            <div class="flex p-1 bg-stone-200/50 rounded-xl mb-4">
                <button v-for="type in ['todo','shopping','wishlist']" :key="type" @click="planType = type" :class="planType === type ? 'bg-white shadow-sm text-muji-text' : 'text-muji-sub'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all capitalize">{{ type === 'todo' ? '待辦' : type === 'shopping' ? '購物' : '想去' }}</button>
            </div>
            <!-- Todo -->
            <div v-if="planType === 'todo'" class="space-y-3">
                <div v-for="(item, idx) in todoList" :key="idx" class="bg-white p-4 rounded-3xl shadow-soft flex items-center gap-3 active:scale-[0.98] transition-transform">
                    <button @click="item.done = !item.done" :class="item.done ? 'bg-muji-accent border-muji-accent' : 'border-stone-300'" class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors"><i v-if="item.done" class="fa-solid fa-check text-white text-xs"></i></button>
                    <span :class="item.done ? 'text-stone-300 line-through' : 'text-muji-text'" class="flex-1 font-medium">{{ item.text }}</span>
                    <button @click="deleteTodo(idx)" class="text-stone-200 hover:text-red-400 p-2"><i class="fa-solid fa-trash-can"></i></button>
                </div>
                <button @click="addTodo" class="w-full py-3 rounded-2xl border-2 border-dashed border-stone-300 text-stone-400 font-bold hover:bg-white transition-colors">+ 新增待辦</button>
            </div>
            <!-- Shopping -->
            <div v-if="planType === 'shopping'" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div v-for="(item, idx) in shoppingList" :key="idx" class="bg-white rounded-3xl shadow-soft overflow-hidden relative group">
                        <div class="aspect-square bg-stone-100 relative">
                            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                            <div v-else class="w-full h-full flex items-center justify-center text-stone-300"><i class="fa-solid fa-gift text-3xl"></i></div>
                            <button @click="deleteShopping(idx)" class="absolute top-2 right-2 w-8 h-8 bg-white/90 rounded-full text-red-400 shadow-sm flex items-center justify-center"><i class="fa-solid fa-trash text-xs"></i></button>
                        </div>
                        <div class="p-3"><p class="font-bold text-sm truncate text-muji-text">{{ item.name }}</p><p class="text-xs text-stone-400 mt-1">¥{{ item.price }}</p></div>
                    </div>
                </div>
                <button @click="openItemModal('shopping')" class="fixed bottom-10 right-5 w-14 h-14 bg-stone-800 text-white rounded-[1.25rem] shadow-float flex items-center justify-center text-xl z-20 active:scale-90 transition-transform"><i class="fa-solid fa-camera"></i></button>
            </div>
            <!-- Wishlist -->
            <div v-if="planType === 'wishlist'" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div v-for="(item, idx) in wishlist" :key="idx" class="bg-white rounded-3xl shadow-soft overflow-hidden relative group">
                        <div class="aspect-video bg-stone-100 relative">
                            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                            <div v-else class="w-full h-full flex items-center justify-center text-stone-300"><i class="fa-solid fa-location-dot text-3xl"></i></div>
                            <button @click="deleteWishlist(idx)" class="absolute top-2 right-2 w-8 h-8 bg-white/90 rounded-full text-red-400 shadow-sm flex items-center justify-center"><i class="fa-solid fa-trash text-xs"></i></button>
                        </div>
                        <div class="p-3"><p class="font-bold text-sm truncate text-muji-text">{{ item.name }}</p><p class="text-xs text-stone-400 mt-1 truncate">{{ item.note || '無備註' }}</p></div>
                    </div>
                </div>
                <button @click="openItemModal('wishlist')" class="fixed bottom-10 right-5 w-14 h-14 bg-muji-accent text-white rounded-[1.25rem] shadow-float flex items-center justify-center text-xl z-20 active:scale-90 transition-transform"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>

        <!-- 3. 行程 (Itinerary) -->
        <div v-if="currentTab === 'itinerary'" class="fade-in h-full flex flex-col pb-safe-bottom">
            <div class="shrink-0 bg-muji-bg z-20 pb-2 pt-2 border-b border-stone-200/50">
                <div class="flex items-end gap-3 overflow-x-auto hide-scrollbar px-4 pb-2">
                    <div v-for="(day, idx) in itinerary" :key="idx" @click="currDayIdx = idx" class="flex-shrink-0 relative group transition-all duration-300 cursor-pointer select-none">
                        <div :class="currDayIdx === idx ? 'bg-stone-800 text-white shadow-lg -translate-y-1' : 'bg-white text-stone-400 border border-stone-100'" class="flex flex-col items-center justify-center w-[4.5rem] h-24 rounded-[1.5rem] transition-all duration-300">
                            <span class="text-[10px] uppercase tracking-widest opacity-60 mb-0.5">Day {{ idx + 1 }}</span>
                            <span class="text-xs font-medium opacity-80">{{ getWeekName(day.date) }}</span>
                            <span class="text-2xl font-bold font-sans mt-1 leading-none">{{ getDayDate(day.date) }}</span>
                        </div>
                        <div v-if="currDayIdx === idx" class="absolute -bottom-3 left-1/2 -translate-x-1/2 flex gap-1 z-10 slide-up">
                            <button @click.stop="editDayDate(idx)" class="w-6 h-6 rounded-full bg-stone-200 text-stone-600 text-[10px] flex items-center justify-center shadow-sm border-2 border-muji-bg"><i class="fa-solid fa-pen"></i></button>
                            <button @click.stop="deleteDay(idx)" class="w-6 h-6 rounded-full bg-red-100 text-red-500 text-[10px] flex items-center justify-center shadow-sm border-2 border-muji-bg"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <button @click="addDay" class="flex-shrink-0 w-12 h-20 mb-2 rounded-[1.5rem] border-2 border-dashed border-stone-300 text-stone-300 flex items-center justify-center hover:bg-white hover:text-muji-accent hover:border-muji-accent transition-all active:scale-95"><i class="fa-solid fa-plus text-xl"></i></button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto hide-scrollbar pl-4 pr-4 pt-4 relative pb-24">
                <div v-if="currentEvents.length > 0" class="flex gap-4 mb-4 opacity-70 hover:opacity-100 transition-opacity">
                    <div class="w-12 flex flex-col items-center justify-end pb-2"><i class="fa-solid fa-bed text-stone-300 mb-1"></i><div class="w-0.5 h-6 bg-stone-200 border-l border-dashed border-stone-300"></div></div>
                    <div class="flex-1 bg-stone-100/50 rounded-2xl p-3 flex items-center justify-between text-xs text-stone-500 border border-stone-100">
                        <div class="flex items-center gap-2"><span class="bg-white px-2 py-1 rounded-md shadow-sm text-[10px]">前一晚</span><span>{{ previousNightHotel ? previousNightHotel.name : '尚未安排住宿' }}</span></div>
                        <!-- 第一個景點前的交通 (從飯店出發) -->
                        <button @click="openTransportModal(0)" class="flex items-center gap-1 bg-white px-2 py-1 rounded-full shadow-sm hover:text-muji-accent transition-colors">
                            <i :class="getTransportIcon(currentEvents[0].transport?.mode || 'transport')" class="text-stone-400"></i>
                            <span class="font-bold">{{ currentEvents[0].transport?.duration || '出發' }}</span>
                        </button>
                    </div>
                </div>
                
                <div id="itinerary-list" class="space-y-0">
                    <div v-for="(event, idx) in currentEvents" :key="event.id" :data-id="event.id" class="relative group">
                        
                        <!-- 景點之間的交通資訊顯示區塊 (變更為藍色/細緻版) -->
                        <div v-if="idx > 0" class="flex gap-4 min-h-[2.5rem] relative z-0 my-1">
                             <div class="w-12 flex justify-center h-full"><div class="w-0.5 h-full bg-stone-300"></div></div>
                             <div class="flex-1 flex items-center">
                                 <button @click="openTransportModal(idx)" 
                                         class="w-full flex items-center gap-3 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-lg text-xs text-blue-900 transition-all border border-blue-100 hover:border-blue-300 group/trans shadow-sm">
                                     <!-- 如果有設定交通資訊 -->
                                     <template v-if="event.transport">
                                         <!-- Icon 變小 (w-6 h-6) 且變藍色 -->
                                         <div class="w-6 h-6 rounded-full bg-blue-200 text-blue-600 flex items-center justify-center shrink-0">
                                             <i :class="getTransportIcon(event.transport.mode)" class="text-[10px]"></i>
                                         </div>
                                         <div class="flex-1 text-left flex items-center justify-between gap-2 overflow-hidden">
                                             <!-- 左側：地點與圖示 -->
                                             <div class="flex items-center gap-2 truncate min-w-0">
                                                 <p class="text-[10px] text-blue-800/70 truncate font-medium">
                                                     <span v-if="event.transport.depLoc">{{ event.transport.depLoc }}</span>
                                                     <span v-else>起點</span>
                                                     <i class="fa-solid fa-caret-right mx-1 opacity-50"></i>
                                                     <span v-if="event.transport.arrLoc">{{ event.transport.arrLoc }}</span>
                                                     <span v-else>終點</span>
                                                 </p>
                                             </div>
                                             
                                             <!-- 右側：時間與耗時 -->
                                             <div class="flex items-center gap-2 shrink-0">
                                                 <span class="font-bold text-blue-900 text-[10px] font-mono">{{ event.transport.depTime }}</span>
                                                 <i class="fa-solid fa-arrow-right text-[8px] text-blue-300"></i>
                                                 <span class="font-bold text-blue-900 text-[10px] font-mono">{{ event.transport.arrTime }}</span>
                                                 <span class="text-[9px] bg-white px-1.5 py-0.5 rounded text-blue-600 font-bold border border-blue-100 shadow-sm">{{ event.transport.duration }}</span>
                                             </div>
                                         </div>
                                         <i class="fa-solid fa-pen text-blue-300 opacity-0 group-hover/trans:opacity-100 transition-opacity text-[10px]"></i>
                                     </template>
                                     
                                     <!-- 如果沒有設定 -->
                                     <template v-else>
                                         <div class="w-5 h-5 rounded-full bg-blue-200/50 text-blue-400 flex items-center justify-center"><i class="fa-solid fa-plus text-[8px]"></i></div>
                                         <span class="text-blue-400/70 font-bold text-[10px]">新增交通</span>
                                     </template>
                                 </button>
                             </div>
                        </div>
                        
                        <!-- 景點卡片 -->
                        <div class="flex items-start relative z-10 cursor-grab active:cursor-grabbing">
                            <div class="w-12 flex flex-col items-center shrink-0 pt-1">
                                <div class="w-12 h-12 rounded-[1rem] bg-stone-800 text-white shadow-lg flex flex-col items-center justify-center border-2 border-white ring-1 ring-stone-100 z-10">
                                    <span class="text-sm font-bold leading-none">{{ event.time.split(':')[0] }}</span><span class="text-[10px] opacity-60 leading-none">{{ event.time.split(':')[1] }}</span>
                                </div>
                                <div v-if="idx < currentEvents.length - 1" class="w-0.5 h-full bg-stone-300 absolute top-12 left-6 -translate-x-1/2 -z-10"></div>
                            </div>
                            <div class="ml-4 flex-1 bg-white rounded-[1.5rem] p-4 shadow-soft active:scale-[0.99] transition-transform border border-stone-50 relative overflow-hidden" @click="editEvent(event)">
                                <div class="flex justify-between items-start mb-2">
                                    <span :class="getCatColor(event.category)" class="text-[10px] text-white px-2 py-0.5 rounded-lg font-bold shadow-sm tracking-wide"><i :class="getCatIcon(event.category)" class="mr-1"></i>{{ translateCat(event.category) }}</span>
                                    <button @click.stop="openMap(event.name)" class="w-8 h-8 rounded-full bg-stone-100 text-stone-600 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center transition-colors"><i class="fa-solid fa-location-arrow text-xs"></i></button>
                                </div>
                                <h3 class="font-bold text-lg text-muji-text leading-tight mb-2">{{ event.name }}</h3>
                                <div class="flex flex-wrap gap-2 mb-3">
                                    <div v-if="['spot','food','shopping'].includes(event.category) && event.openTime" class="text-[10px] text-stone-500 bg-stone-50 px-2 py-1 rounded-md"><i class="fa-regular fa-clock mr-1 text-stone-400"></i>{{ event.openTime }}</div>
                                    <div v-if="event.category === 'spot' && event.ticket" class="text-[10px] text-stone-500 bg-stone-50 px-2 py-1 rounded-md"><i class="fa-solid fa-ticket mr-1 text-stone-400"></i>{{ event.ticket }}</div>
                                </div>
                                <p v-if="event.note" class="text-xs text-stone-400 bg-stone-50/50 p-2 rounded-xl border border-stone-100/50 line-clamp-2">{{ event.note }}</p>
                                <div class="absolute right-2 bottom-2 text-stone-200 opacity-50"><i class="fa-solid fa-grip-lines"></i></div>
                            </div>
                        </div>
                    </div>
                    <div v-if="currentEvents.length === 0" class="flex flex-col items-center justify-center py-10 text-stone-300"><i class="fa-regular fa-map text-4xl mb-2 opacity-50"></i><p class="text-xs">這一天還沒安排行程</p></div>
                </div>
                <div class="h-10"></div>
            </div>
            <button @click="openEventModal" class="fixed bottom-6 right-6 w-14 h-14 bg-stone-800 text-white rounded-[1.25rem] shadow-float flex items-center justify-center text-2xl z-40 active:scale-90 transition-transform hover:bg-stone-700"><i class="fa-solid fa-plus"></i></button>
        </div>

        <!-- 4. 記帳 (Accounting) -->
        <div v-if="currentTab === 'accounting'" class="fade-in space-y-6 pb-20">
            <div class="bg-stone-800 text-[#F9F9F7] rounded-[2rem] p-6 shadow-float relative overflow-hidden">
                <p class="text-xs text-stone-400 uppercase tracking-widest mb-1">Total Spent</p>
                <h2 class="text-4xl font-bold font-sans">¥ {{ totalExpense.toLocaleString() }}</h2>
                <div class="mt-6 flex gap-3">
                    <div class="bg-white/10 backdrop-blur rounded-xl px-4 py-2 border border-white/5 flex-1"><p class="text-[10px] text-stone-300">CASH</p><p class="font-bold">¥ {{ totalByMethod('cash').toLocaleString() }}</p></div>
                    <div class="bg-white/10 backdrop-blur rounded-xl px-4 py-2 border border-white/5 flex-1"><p class="text-[10px] text-stone-300">CARD</p><p class="font-bold">¥ {{ totalByMethod('card').toLocaleString() }}</p></div>
                </div>
            </div>
            <div class="space-y-3">
                <div v-for="(exp, idx) in expenses" :key="idx" class="bg-white p-4 rounded-3xl shadow-soft flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div :class="getCatColor(exp.category)" class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm"><i :class="getCatIcon(exp.category)"></i></div>
                        <div><p class="font-bold text-muji-text text-sm">{{ exp.title }}</p><p class="text-xs text-stone-400">{{ exp.payer }} 付款 <span v-if="exp.isPublic" class="text-purple-500 bg-purple-50 px-1 rounded ml-1">公費</span></p></div>
                    </div>
                    <div class="text-right"><p class="font-bold text-muji-text">¥{{ Number(exp.amount).toLocaleString() }}</p><button @click="deleteExpense(idx)" class="text-stone-200 text-xs mt-1 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></div>
                </div>
            </div>
            <button @click="openExpenseModal" class="fixed bottom-10 right-5 w-14 h-14 bg-muji-text text-white rounded-[1.25rem] shadow-float flex items-center justify-center text-xl z-20 active:scale-90 transition-transform"><i class="fa-solid fa-pen"></i></button>
        </div>

        <!-- 5. 成員 (Members) -->
        <div v-if="currentTab === 'members'" class="fade-in pb-20">
            <div class="flex justify-between items-end mb-4 px-1">
                <h2 class="text-lg font-bold text-muji-text">旅伴名單</h2>
                <span class="text-xs text-stone-400 font-bold bg-stone-100 px-2 py-1 rounded-lg">共 {{ members.length }} 人</span>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div v-for="(m, idx) in members" :key="idx" class="bg-white p-5 rounded-[1.5rem] shadow-soft flex flex-col items-center relative group active:scale-[0.98] transition-transform">
                    <button @click="deleteMember(idx)" class="absolute top-2 right-2 w-8 h-8 flex items-center justify-center text-stone-200 hover:text-red-400 hover:bg-red-50 rounded-full transition-colors"><i class="fa-solid fa-xmark"></i></button>
                    <label class="w-20 h-20 rounded-full bg-stone-50 mb-3 overflow-hidden relative cursor-pointer border border-stone-100 shadow-inner group-hover:border-muji-accent transition-colors">
                            <img v-if="m.avatar" :src="m.avatar" class="w-full h-full object-cover">
                            <div v-else class="w-full h-full flex flex-col items-center justify-center text-stone-300"><i class="fa-solid fa-user text-2xl mb-1"></i><span class="text-[10px]">更換</span></div>
                            <input type="file" accept="image/*" @change="(e) => updateMemberAvatar(e, idx)" class="hidden">
                    </label>
                    <span class="font-bold text-muji-text text-lg">{{ m.name }}</span>
                    <span class="text-[10px] text-stone-400 mt-1 bg-stone-100 px-2 rounded-full" v-if="idx === 0">主辦人</span>
                </div>
                <button @click="showMemberModal = true" class="bg-stone-50/50 border-2 border-dashed border-stone-300 rounded-[1.5rem] flex flex-col items-center justify-center min-h-[11rem] gap-2 text-stone-400 hover:bg-white hover:border-muji-accent hover:text-muji-accent transition-all shadow-sm">
                    <div class="w-12 h-12 rounded-full bg-stone-200 flex items-center justify-center text-white text-xl shadow-inner group-hover:bg-muji-accent"><i class="fa-solid fa-plus"></i></div>
                    <span class="text-xs font-bold">加入新旅伴</span>
                </button>
            </div>
        </div>

    </main>

    <!-- Modals -->
    <!-- Transport Modal (新增功能: 交通編輯) -->
    <div v-if="showTransportModal" class="fixed inset-0 z-[70] flex items-end justify-center bg-stone-900/40 backdrop-blur-sm" @click.self="showTransportModal=false">
        <div class="bg-[#F9F9F7] w-full rounded-t-[2rem] p-6 slide-up pb-safe-bottom">
            <div class="w-12 h-1 bg-stone-300 rounded-full mx-auto mb-6"></div>
            <h3 class="text-center font-bold text-lg mb-6 text-stone-700">編輯交通移動</h3>
            
            <div class="space-y-6">
                <!-- 交通方式 Icon 選擇 -->
                <div>
                    <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">交通工具</label>
                    <div class="grid grid-cols-5 gap-2">
                        <button v-for="type in transportTypes" :key="type.id" 
                                @click="transportForm.mode = type.id" 
                                :class="transportForm.mode === type.id ? 'bg-stone-800 text-white ring-2 ring-stone-800 ring-offset-1' : 'bg-white text-stone-400 border border-stone-200'" 
                                class="aspect-square rounded-xl flex flex-col items-center justify-center gap-1 transition-all">
                            <i :class="type.icon" class="text-lg"></i>
                            <span class="text-[10px]">{{ type.name }}</span>
                        </button>
                    </div>
                </div>

                <!-- 地點 -->
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="text-xs font-bold text-stone-400 ml-1 mb-1 block">上車地點 (出發)</label>
                        <input v-model="transportForm.depLoc" placeholder="例如: 札幌站" class="w-full p-3 bg-white rounded-xl font-bold text-stone-700 border border-stone-100 text-sm">
                    </div>
                    <div class="flex items-end pb-3 text-stone-300"><i class="fa-solid fa-arrow-right"></i></div>
                    <div class="flex-1">
                        <label class="text-xs font-bold text-stone-400 ml-1 mb-1 block">下車地點 (抵達)</label>
                        <input v-model="transportForm.arrLoc" placeholder="例如: 小樽站" class="w-full p-3 bg-white rounded-xl font-bold text-stone-700 border border-stone-100 text-sm">
                    </div>
                </div>

                <!-- 時間 -->
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="text-xs font-bold text-stone-400 ml-1 mb-1 block">上車時間</label>
                        <input type="time" v-model="transportForm.depTime" class="w-full p-3 bg-white rounded-xl font-bold text-center text-stone-700 border border-stone-100">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs font-bold text-stone-400 ml-1 mb-1 block">下車時間</label>
                        <input type="time" v-model="transportForm.arrTime" class="w-full p-3 bg-white rounded-xl font-bold text-center text-stone-700 border border-stone-100">
                    </div>
                </div>
                
                <p class="text-center text-xs text-stone-400">
                    預計耗時: <span class="font-bold text-muji-accent">{{ calculateDurationDisplay(transportForm.depTime, transportForm.arrTime) }}</span>
                </p>
            </div>

            <div class="flex gap-3 mt-8">
                <button @click="deleteTransport" class="w-14 bg-red-50 text-red-400 rounded-2xl flex items-center justify-center border border-red-100 active:scale-95 transition-transform"><i class="fa-solid fa-trash"></i></button>
                <button @click="saveTransport" class="flex-1 bg-stone-800 text-white py-4 rounded-2xl font-bold shadow-lg shadow-stone-300/50 active:scale-[0.98] transition-transform flex items-center justify-center gap-2"><i class="fa-solid fa-check"></i> 儲存設定</button>
            </div>
        </div>
    </div>

    <!-- Flight Modal -->
    <div v-if="showFlightModal" class="fixed inset-0 z-[60] flex items-end justify-center bg-stone-900/40 backdrop-blur-sm" @click.self="showFlightModal=false">
        <div class="bg-[#F9F9F7] w-full rounded-t-[2rem] p-6 slide-up pb-safe-bottom">
            <div class="w-12 h-1 bg-stone-300 rounded-full mx-auto mb-6"></div>
            <h3 class="text-center font-bold text-lg mb-6 text-stone-700">{{ flightForm.isEdit ? '編輯航班資訊' : '新增航班' }}</h3>
            <div class="space-y-4">
                <div class="bg-white p-1 rounded-2xl flex shadow-sm border border-stone-100">
                    <button @click="flightForm.type='去程'" :class="flightForm.type==='去程' ? 'bg-muji-accent text-white shadow-sm' : 'text-stone-400'" class="flex-1 py-3 rounded-xl text-sm font-bold transition-all">去程</button>
                    <button @click="flightForm.type='回程'" :class="flightForm.type==='回程' ? 'bg-orange-400 text-white shadow-sm' : 'text-stone-400'" class="flex-1 py-3 rounded-xl text-sm font-bold transition-all">回程</button>
                </div>
                <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400 text-xs font-bold">航班</span><input v-model="flightForm.flightNo" placeholder="例如: JX850" class="w-full pl-14 pr-4 py-4 bg-white rounded-2xl font-bold text-stone-700 shadow-sm border border-stone-100 uppercase"></div>
                <div class="flex gap-2">
                    <div class="flex-1 relative"><span class="absolute top-2 left-4 text-[10px] text-stone-400 font-bold uppercase">出發地</span><input v-model="flightForm.depCode" placeholder="TPE" class="w-full pt-6 pb-2 px-4 bg-white rounded-2xl font-black font-mono text-xl text-center text-stone-700 shadow-sm border border-stone-100 uppercase"></div>
                    <div class="flex items-center justify-center text-stone-300"><i class="fa-solid fa-plane"></i></div>
                    <div class="flex-1 relative"><span class="absolute top-2 left-4 text-[10px] text-stone-400 font-bold uppercase">目的地</span><input v-model="flightForm.arrCode" placeholder="CTS" class="w-full pt-6 pb-2 px-4 bg-white rounded-2xl font-black font-mono text-xl text-center text-stone-700 shadow-sm border border-stone-100 uppercase"></div>
                </div>
                <div class="flex gap-2">
                    <div class="flex-1 relative"><span class="absolute top-2 left-4 text-[10px] text-stone-400 font-bold uppercase">起飛時間</span><input type="time" v-model="flightForm.depTime" class="w-full pt-6 pb-2 px-2 bg-white rounded-2xl font-bold text-xl text-center text-stone-700 shadow-sm border border-stone-100"></div>
                    <div class="flex-1 relative"><span class="absolute top-2 left-4 text-[10px] text-stone-400 font-bold uppercase">抵達時間</span><input type="time" v-model="flightForm.arrTime" class="w-full pt-6 pb-2 px-2 bg-white rounded-2xl font-bold text-xl text-center text-stone-700 shadow-sm border border-stone-100"></div>
                </div>
                <p class="text-center text-xs text-stone-400 mt-2">預計飛行時間: <span class="font-bold text-muji-accent">{{ calculateDurationDisplay(flightForm.depTime, flightForm.arrTime) }}</span></p>
            </div>
            <div class="flex gap-3 mt-8">
                <button v-if="flightForm.isEdit" @click="deleteFlightEdit" class="w-14 bg-red-50 text-red-400 rounded-2xl flex items-center justify-center border border-red-100 active:scale-95 transition-transform"><i class="fa-solid fa-trash"></i></button>
                <button @click="saveFlight" class="flex-1 bg-stone-800 text-white py-4 rounded-2xl font-bold shadow-lg shadow-stone-300/50 active:scale-[0.98] transition-transform flex items-center justify-center gap-2"><i class="fa-solid fa-check"></i> {{ flightForm.isEdit ? '儲存變更' : '新增航班' }}</button>
            </div>
        </div>
    </div>
    
    <!-- Other Modals -->
    <div v-if="showItemModal" class="fixed inset-0 z-[60] flex items-end justify-center bg-stone-900/30 backdrop-blur-sm" @click.self="showItemModal=false"><div class="bg-white w-full rounded-t-[2rem] p-6 slide-up pb-safe-bottom"><h3 class="text-center font-bold text-lg mb-6">{{ itemFormType === 'shopping' ? '新增購物清單' : '新增想去景點' }}</h3><label class="block w-full h-32 bg-stone-50 rounded-2xl border-2 border-dashed border-stone-200 mb-4 flex items-center justify-center relative overflow-hidden"><img v-if="itemForm.image" :src="itemForm.image" class="w-full h-full object-cover"><div v-else class="text-stone-400 flex flex-col items-center"><i class="fa-solid fa-camera mb-1"></i><span class="text-xs">上傳照片</span></div><input type="file" accept="image/*" @change="handleItemImg" class="hidden"></label><input v-model="itemForm.name" placeholder="名稱" class="w-full p-4 bg-stone-50 rounded-2xl mb-3 font-bold"><input v-if="itemFormType==='shopping'" type="number" v-model="itemForm.price" placeholder="價格 (JPY)" class="w-full p-4 bg-stone-50 rounded-2xl mb-6"><input v-else v-model="itemForm.note" placeholder="備註 / 說明" class="w-full p-4 bg-stone-50 rounded-2xl mb-6"><button @click="saveItem" class="w-full bg-stone-800 text-white py-4 rounded-2xl font-bold shadow-lg">加入</button></div></div>
    <div v-if="showExpModal" class="fixed inset-0 z-[60] flex items-end justify-center bg-stone-900/30 backdrop-blur-sm" @click.self="showExpModal=false"><div class="bg-white w-full rounded-t-[2rem] p-6 slide-up pb-safe-bottom"><h3 class="text-center font-bold text-lg mb-4">記一筆</h3><div class="bg-stone-100 rounded-2xl p-4 mb-4 text-center"><input type="number" inputmode="decimal" v-model="expForm.amount" placeholder="0" class="bg-transparent text-4xl font-bold text-center w-full text-muji-text"><span class="text-xs text-stone-400">JPY</span></div><input v-model="expForm.title" placeholder="項目" class="w-full p-4 bg-stone-50 rounded-2xl mb-3 font-bold"><div class="flex gap-2 overflow-x-auto hide-scrollbar mb-4"><button v-for="m in members" :key="m.name" @click="expForm.payer=m.name" :class="expForm.payer===m.name ? 'bg-stone-800 text-white' : 'bg-stone-100 text-stone-400'" class="px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-colors">{{ m.name }}</button></div><div class="grid grid-cols-2 gap-3 mb-4"><button @click="expForm.method='cash'" :class="expForm.method==='cash'?'bg-stone-200 ring-2 ring-stone-400':'bg-stone-50'" class="py-3 rounded-xl text-sm font-bold text-stone-600">現金</button><button @click="expForm.method='card'" :class="expForm.method==='card'?'bg-blue-100 ring-2 ring-blue-300 text-blue-600':'bg-stone-50'" class="py-3 rounded-xl text-sm font-bold text-stone-400">信用卡</button></div><div class="flex items-center justify-between p-4 bg-stone-50 rounded-2xl mb-6"><span class="font-bold text-stone-600 text-sm">公費 (大家平分)</span><div @click="expForm.isPublic=!expForm.isPublic" :class="expForm.isPublic?'bg-green-400':'bg-stone-300'" class="w-10 h-6 rounded-full relative transition-colors"><div :class="expForm.isPublic?'left-5':'left-1'" class="absolute top-1 w-4 h-4 bg-white rounded-full transition-all"></div></div></div><button @click="saveExpense" class="w-full bg-stone-800 text-white py-4 rounded-2xl font-bold shadow-lg">儲存</button></div></div>
    <div v-if="showEventModal" class="fixed inset-0 z-[60] flex items-end justify-center bg-stone-900/40 backdrop-blur-sm" @click.self="showEventModal=false"><div class="bg-[#F9F9F7] w-full rounded-t-[2rem] p-6 slide-up pb-safe-bottom max-h-[90vh] overflow-y-auto"><div class="w-12 h-1 bg-stone-300 rounded-full mx-auto mb-6"></div><h3 class="text-center font-bold text-lg mb-6 text-stone-700">{{ isEditing ? '編輯行程' : '新增行程' }}</h3><div class="space-y-5"><div><label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">分類</label><div class="grid grid-cols-3 gap-2"><button v-for="c in ['spot','food','shopping','hotel','transport','other']" :key="c" @click="eventForm.category=c" :class="eventForm.category===c ? 'bg-stone-800 text-white ring-2 ring-stone-800 ring-offset-1' : 'bg-white text-stone-400 border border-stone-200'" class="py-2.5 rounded-xl text-xs font-bold transition-all flex items-center justify-center gap-1"><i :class="getCatIcon(c)"></i> {{ translateCat(c) }}</button></div></div><div><label class="text-xs font-bold text-stone-400 ml-1 mb-1 block">名稱</label><div class="relative"><input v-model="eventForm.name" placeholder="輸入地點名稱..." class="w-full p-4 bg-white rounded-2xl font-bold text-stone-700 shadow-sm border border-stone-100 focus:border-stone-400 transition-colors"><button v-if="eventForm.name" @click="openMap(eventForm.name)" class="absolute right-3 top-1/2 -translate-y-1/2 text-stone-400 hover:text-blue-500"><i class="fa-solid fa-map-location-dot"></i></button></div></div><div><label class="text-xs font-bold text-stone-400 ml-1 mb-1 block">開始時間</label><input type="time" v-model="eventForm.time" class="w-full p-4 bg-white rounded-2xl font-bold text-center text-xl text-stone-700 shadow-sm border border-stone-100"></div><div v-if="['spot','food','shopping','hotel'].includes(eventForm.category)" class="fade-in"><label class="text-xs font-bold text-stone-400 ml-1 mb-1 block">營業/入住時間</label><input v-model="eventForm.openTime" placeholder="例如: 09:00 - 22:00" class="w-full p-4 bg-white rounded-2xl text-sm shadow-sm border border-stone-100"></div><div v-if="eventForm.category === 'spot'" class="fade-in"><label class="text-xs font-bold text-stone-400 ml-1 mb-1 block">門票 / 預算</label><input v-model="eventForm.ticket" placeholder="例如: ¥2000 / 免費" class="w-full p-4 bg-white rounded-2xl text-sm shadow-sm border border-stone-100"></div><div><label class="text-xs font-bold text-stone-400 ml-1 mb-1 block">特色 & 備註</label><textarea v-model="eventForm.note" placeholder="例如: 必吃霜淇淋、記得帶護照..." class="w-full p-4 bg-white rounded-2xl h-24 text-sm text-stone-600 resize-none shadow-sm border border-stone-100"></textarea></div></div><div class="flex gap-3 mt-8"><button v-if="isEditing" @click="confirmDeleteEvent" class="w-14 bg-red-50 text-red-400 rounded-2xl flex items-center justify-center border border-red-100 active:scale-95 transition-transform"><i class="fa-solid fa-trash"></i></button><button @click="saveEvent" class="flex-1 bg-stone-800 text-white py-4 rounded-2xl font-bold shadow-lg shadow-stone-300/50 active:scale-[0.98] transition-transform flex items-center justify-center gap-2"><i class="fa-solid fa-check"></i> {{ isEditing ? '儲存變更' : '加入行程' }}</button></div></div></div>
    <div v-if="showMemberModal" class="fixed inset-0 z-[60] flex items-end justify-center bg-stone-900/30 backdrop-blur-sm" @click.self="showMemberModal=false"><div class="bg-white w-full rounded-t-[2rem] p-6 slide-up pb-safe-bottom"><h3 class="text-center font-bold text-lg mb-6">新增旅伴</h3><div class="bg-stone-50 rounded-2xl p-6 mb-6 flex flex-col items-center justify-center border border-stone-100"><div class="w-20 h-20 rounded-full bg-stone-200 mb-4 flex items-center justify-center text-white text-3xl shadow-inner"><i class="fa-solid fa-user"></i></div><p class="text-xs text-stone-400">頭像可在新增後點擊圖片上傳</p></div><input v-model="newMemberName" placeholder="旅伴名字 (例如: 小明)" class="w-full p-4 bg-stone-50 rounded-2xl mb-6 font-bold text-center text-lg placeholder-stone-300 focus:bg-white focus:ring-2 focus:ring-stone-100 transition-all"><button @click="addMember" class="w-full bg-stone-800 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-[0.98] transition-transform">確認加入</button></div></div>
    <div v-if="showHotelModal" class="fixed inset-0 z-[60] flex items-end justify-center bg-stone-900/30 backdrop-blur-sm" @click.self="showHotelModal=false">
        <div class="bg-white w-full rounded-t-[2rem] p-6 slide-up pb-safe-bottom">
            <h3 class="text-center font-bold text-lg mb-6">{{ hotelForm.id ? '編輯住宿' : '新增住宿' }}</h3>
            <label class="block w-full h-32 bg-stone-50 rounded-2xl border-2 border-dashed border-stone-200 mb-4 flex items-center justify-center relative overflow-hidden">
                <img v-if="hotelForm.image" :src="hotelForm.image" class="w-full h-full object-cover">
                <div v-else class="text-stone-400 flex flex-col items-center"><i class="fa-solid fa-hotel mb-1"></i><span class="text-xs">飯店照片</span></div>
                <input type="file" accept="image/*" @change="handleHotelImg" class="hidden">
            </label>
            <div class="space-y-3">
                <input v-model="hotelForm.name" placeholder="飯店名稱" class="w-full p-4 bg-stone-50 rounded-2xl font-bold">
                <input v-model="hotelForm.address" placeholder="地址" class="w-full p-4 bg-stone-50 rounded-2xl text-sm">
                <div class="flex gap-2">
                    <div class="flex-1 bg-stone-50 p-3 rounded-2xl"><span class="block text-[10px] text-stone-400 mb-1 font-bold">入住日期</span><input type="date" v-model="hotelForm.startDate" class="bg-transparent font-bold w-full text-sm text-stone-600 font-sans"></div>
                    <div class="flex-1 bg-stone-50 p-3 rounded-2xl"><span class="block text-[10px] text-stone-400 mb-1 font-bold">退房日期</span><input type="date" v-model="hotelForm.endDate" class="bg-transparent font-bold w-full text-sm text-stone-600 font-sans"></div>
                </div>
                <div class="flex gap-2">
                    <div class="flex-1 bg-stone-50 p-3 rounded-2xl"><span class="block text-[10px] text-stone-400 mb-1">Check-in</span><input type="time" v-model="hotelForm.checkIn" class="bg-transparent font-bold w-full text-center"></div>
                    <div class="flex-1 bg-stone-50 p-3 rounded-2xl"><span class="block text-[10px] text-stone-400 mb-1">Check-out</span><input type="time" v-model="hotelForm.checkOut" class="bg-transparent font-bold w-full text-center"></div>
                </div>
                <div class="bg-stone-50 p-4 rounded-2xl flex items-center gap-2"><span class="text-sm font-bold text-stone-500">總金額 (JPY)</span><input type="number" v-model="hotelForm.price" class="bg-transparent text-right font-bold text-lg w-full" placeholder="0"></div>
            </div>
            <div class="flex gap-3 mt-6">
                <button v-if="hotelForm.id" @click="deleteHotel" class="w-14 bg-red-50 text-red-400 rounded-2xl flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>
                <button @click="saveHotel" class="flex-1 bg-stone-800 text-white py-4 rounded-2xl font-bold shadow-lg">儲存</button>
            </div>
        </div>
    </div>

</div>

<!-- Scripts -->
<script type="module">
    import { createApp, ref, computed, reactive, onMounted, watch, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref as dbRef, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyD0FLDk9GqIUK2Kx7UzAYi5U6Dzs4QWrDw",
        authDomain: "sini-3e19d.firebaseapp.com",
        projectId: "sini-3e19d",
        storageBucket: "sini-3e19d.firebasestorage.app",
        messagingSenderId: "327933716448",
        appId: "1:327933716448:web:a964cf7e9da04b9bf66d85"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    createApp({
        setup() {
            // User & Auth
            const user = ref(null);
            const currentTab = ref('info');
            const syncStatus = ref('offline');
            const syncStatusClass = computed(() => ({
                'sync-offline': syncStatus.value === 'offline',
                'sync-online': syncStatus.value === 'online',
                'sync-saving': syncStatus.value === 'saving'
            }));

            const tabs = [
                { id: 'info', name: '資訊', icon: 'fa-solid fa-info' },
                { id: 'planning', name: '準備', icon: 'fa-solid fa-bag-shopping' },
                { id: 'itinerary', name: '行程', icon: 'fa-regular fa-map' },
                { id: 'accounting', name: '記帳', icon: 'fa-solid fa-wallet' },
                { id: 'members', name: '成員', icon: 'fa-solid fa-user-group' }
            ];

            // Data Objects
            const members = ref([{name:'我', avatar:''}]);
            const todoList = ref([{text:'辦簽證', done:false}]);
            const shoppingList = ref([]);
            const wishlist = ref([]);
            const itinerary = ref([{date:'2025-01-23', events:[]}]);
            const expenses = ref([]);
            const hotels = ref([]);
            const flights = ref([
                { id: 1, type:'去程', flightNo: 'JX850', depCode:'TPE', arrCode:'CTS', depTime:'09:25', arrTime:'14:00', duration:'3h35m' },
                { id: 2, type:'回程', flightNo: 'JX851', depCode:'CTS', arrCode:'TPE', depTime:'15:00', arrTime:'18:40', duration:'4h40m' }
            ]);

            // Weather & Rate
            const exchangeRate = ref(0.052);
            const exchangeInput = ref(1000);
            const weather = ref({ lastUpdate: '-', current: { temp: 0, feelsLike: 0, desc: 'Loading', icon: 'fa-solid fa-spinner fa-spin' }, forecast: [] });

            const fetchRate = async () => { try { const res = await fetch('https://open.er-api.com/v6/latest/JPY'); const data = await res.json(); if (data?.rates?.HKD) exchangeRate.value = data.rates.HKD; } catch (e) { console.error("匯率失敗", e); }};
            const getWmoIcon = (code) => { if ([0, 1].includes(code)) return 'fa-solid fa-sun text-yellow-400'; if ([2, 3].includes(code)) return 'fa-solid fa-cloud-sun text-white'; if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(code)) return 'fa-solid fa-cloud-rain text-blue-300'; if ([71, 73, 75, 77, 85, 86].includes(code)) return 'fa-regular fa-snowflake text-white animate-pulse'; return 'fa-solid fa-cloud text-gray-200'; };
            const fetchWeather = async () => { try { const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=43.0618&longitude=141.3545&current=temperature_2m,apparent_temperature,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=4'); const data = await res.json(); if(!data.current) return; weather.value.current = { temp: Math.round(data.current.temperature_2m), feelsLike: Math.round(data.current.apparent_temperature), desc: '札幌', icon: getWmoIcon(data.current.weather_code) }; weather.value.forecast = data.daily.time.slice(1, 4).map((time, index) => { const i = index + 1; const d = new Date(time); return { date: `${d.getMonth()+1}/${d.getDate()}`, max: Math.round(data.daily.temperature_2m_max[i]), min: Math.round(data.daily.temperature_2m_min[i]), icon: getWmoIcon(data.daily.weather_code[i]) }; }); const now = new Date(); weather.value.lastUpdate = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`; } catch (e) { console.error(e); } };

            // Forms & Modals
            const showMemberModal = ref(false); const newMemberName = ref('');
            const hotelForm = reactive({ id:null, name:'', address:'', startDate:'', endDate:'', checkIn:'15:00', checkOut:'11:00', price:'', image:'' });
            const showHotelModal = ref(false); 
            const showItemModal = ref(false); const itemFormType = ref('shopping'); const itemForm = reactive({name:'', price:'', note:'', image:''});
            const showExpModal = ref(false); const expForm = reactive({amount:'', title:'', payer:'我', method:'cash', isPublic:true, category:'food'});
            const showEventModal = ref(false); const isEditing = ref(false); const currDayIdx = ref(0); const planType = ref('todo');
            const eventForm = reactive({ id: null, name: '', time: '10:00', category: 'spot', ticket: '', openTime: '', note: '', transportMode: 'transport', travelTime: '' });
            const showFlightModal = ref(false); const flightForm = reactive({ idx: null, isEdit: false, type: '去程', flightNo: '', depCode: '', arrCode: '', depTime: '', arrTime: '' });
            
            // --- Transport Logic (新增/修改) ---
            const showTransportModal = ref(false);
            const transportForm = reactive({ idx: null, mode: 'subway', depLoc: '', arrLoc: '', depTime: '', arrTime: '' });
            const transportTypes = [
                { id: 'subway', name: '地鐵', icon: 'fa-solid fa-train-subway' },
                { id: 'bus', name: '巴士', icon: 'fa-solid fa-bus' },
                { id: 'shinkansen', name: 'JR/新幹線', icon: 'fa-solid fa-train' },
                { id: 'walk', name: '步行', icon: 'fa-solid fa-person-walking' },
                { id: 'car', name: '自駕', icon: 'fa-solid fa-car' }
            ];

            const getTransportIcon = (m) => {
                const t = transportTypes.find(t => t.id === m);
                return t ? t.icon : 'fa-solid fa-arrow-right';
            };

            const openTransportModal = (idx) => {
                const events = itinerary.value[currDayIdx.value].events;
                const evt = events[idx];
                
                // 初始化表單
                transportForm.idx = idx;
                
                // 如果已經有資料，就載入
                if (evt.transport) {
                    Object.assign(transportForm, evt.transport);
                } else {
                    // 預設值
                    const prevEvt = idx > 0 ? events[idx-1] : { name: '前一個地點', time: '09:00' };
                    transportForm.mode = 'subway';
                    transportForm.depLoc = idx > 0 ? prevEvt.name : (previousNightHotel.value?.name || '飯店');
                    transportForm.arrLoc = evt.name;
                    transportForm.depTime = idx > 0 ? prevEvt.time : '09:00';
                    transportForm.arrTime = evt.time;
                }
                showTransportModal.value = true;
            };

            const saveTransport = () => {
                const events = itinerary.value[currDayIdx.value].events;
                const idx = transportForm.idx;
                if (idx !== null && events[idx]) {
                    // 計算時長
                    const duration = calcDurationStr(transportForm.depTime, transportForm.arrTime);
                    
                    // 儲存到 event 物件中的 transport 屬性
                    events[idx].transport = {
                        mode: transportForm.mode,
                        depLoc: transportForm.depLoc,
                        arrLoc: transportForm.arrLoc,
                        depTime: transportForm.depTime,
                        arrTime: transportForm.arrTime,
                        duration: duration
                    };
                }
                showTransportModal.value = false;
            };

            const deleteTransport = () => {
                if (confirm('確定要移除此交通資訊嗎？')) {
                    const events = itinerary.value[currDayIdx.value].events;
                    if (transportForm.idx !== null && events[transportForm.idx]) {
                        delete events[transportForm.idx].transport;
                    }
                    showTransportModal.value = false;
                }
            };

            // Helper for calculations
            const calcDurationStr = (start, end) => { if(!start || !end) return '--'; const [h1, m1] = start.split(':').map(Number); const [h2, m2] = end.split(':').map(Number); let mins = (h2 * 60 + m2) - (h1 * 60 + m1); if (mins < 0) mins += 24 * 60; const h = Math.floor(mins / 60); const m = mins % 60; return `${h > 0 ? h+'h' : ''}${m}m`; };
            const calculateDurationDisplay = (start, end) => calcDurationStr(start, end);
            const isNextDay = (start, end) => { if(!start || !end) return false; const [h1, m1] = start.split(':').map(Number); const [h2, m2] = end.split(':').map(Number); return (h2 * 60 + m2) < (h1 * 60 + m1); };
            const openFlightModal = (flight = null, idx = null) => { if (flight) { flightForm.isEdit = true; flightForm.idx = idx; Object.assign(flightForm, flight); } else { flightForm.isEdit = false; flightForm.idx = null; Object.assign(flightForm, { type: '去程', flightNo: '', depCode: '', arrCode: '', depTime: '10:00', arrTime: '14:00' }); } showFlightModal.value = true; };
            const saveFlight = () => { const duration = calcDurationStr(flightForm.depTime, flightForm.arrTime); const flightData = { type: flightForm.type, flightNo: flightForm.flightNo.toUpperCase(), depCode: flightForm.depCode.toUpperCase(), arrCode: flightForm.arrCode.toUpperCase(), depTime: flightForm.depTime, arrTime: flightForm.arrTime, duration }; if (flightForm.isEdit && flightForm.idx !== null) flights.value[flightForm.idx] = { ...flightData, id: flights.value[flightForm.idx].id }; else flights.value.push({ ...flightData, id: Date.now() }); showFlightModal.value = false; };
            const deleteFlightEdit = () => { if (confirm('刪除航班?')) { if (flightForm.idx !== null) flights.value.splice(flightForm.idx, 1); showFlightModal.value = false; } };

            // Firebase Sync
            const tripId = 'my_hokkaido_trip_v1';
            const dbPath = dbRef(db, 'trips/' + tripId);
            let isReceivingUpdate = false;
            const login = () => { console.log("Login"); const provider = new GoogleAuthProvider(); signInWithPopup(auth, provider).catch(err => alert("登入失敗: " + err.message)); };
            onMounted(() => { fetchWeather(); fetchRate(); onAuthStateChanged(auth, (currentUser) => { user.value = currentUser; if (currentUser) initDataSync(); else syncStatus.value = 'offline'; }); });
            const initDataSync = () => { onValue(dbPath, (snapshot) => { const data = snapshot.val(); if (data) { isReceivingUpdate = true; members.value = data.members || [{name:'我', avatar:''}]; todoList.value = data.todoList || []; shoppingList.value = data.shoppingList || []; wishlist.value = data.wishlist || []; itinerary.value = (data.itinerary || [{date:'2025-01-23', events:[]}]).map(day => ({...day, events: day.events || []})); expenses.value = data.expenses || []; flights.value = data.flights || []; hotels.value = data.hotels || []; setTimeout(() => { isReceivingUpdate = false; initSortable(); }, 100); syncStatus.value = 'online'; } else { saveToFirebase(); } }); };
            let saveTimeout;
            const saveToFirebase = () => { if(!user.value || isReceivingUpdate) return; syncStatus.value = 'saving'; clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { set(dbPath, { members: members.value, todoList: todoList.value, shoppingList: shoppingList.value, wishlist: wishlist.value, itinerary: itinerary.value, expenses: expenses.value, flights: flights.value, hotels: hotels.value, lastModified: Date.now(), updatedBy: user.value.displayName }).then(() => syncStatus.value = 'online').catch(() => syncStatus.value = 'offline'); }, 1000); };
            watch([members, todoList, shoppingList, wishlist, itinerary, expenses, flights, hotels], () => saveToFirebase(), { deep: true });

            // Actions
            const initSortable = () => { if(currentTab.value !== 'itinerary') return; nextTick(() => { const el = document.getElementById('itinerary-list'); if (el && !el._sortable) { Sortable.create(el, { animation: 150, handle: '.group', delay: 150, delayOnTouchOnly: true, onEnd: (evt) => { const events = itinerary.value[currDayIdx.value].events; const item = events.splice(evt.oldIndex, 1)[0]; events.splice(evt.newIndex, 0, item); saveToFirebase(); } }); el._sortable = true; } }); };
            watch(currentTab, (newTab) => { if(newTab === 'itinerary') initSortable(); });
            const getWeekName = (d) => ['SUN','MON','TUE','WED','THU','FRI','SAT'][new Date(d).getDay()];
            const getDayDate = (d) => `${new Date(d).getDate()}/${new Date(d).getMonth()+1}`;

            const previousNightHotel = computed(() => {
                if (!itinerary.value || !itinerary.value[currDayIdx.value]) return null;
                const curDateStr = itinerary.value[currDayIdx.value].date;
                if (!curDateStr) return null;
                let prevDateStr = '';
                try {
                    const parts = curDateStr.split(/[-/]/).map(Number);
                    if (parts.length === 3) {
                        const d = new Date(parts[0], parts[1] - 1, parts[2], 12, 0, 0);
                        d.setTime(d.getTime() - 86400000); 
                        const y = d.getFullYear(); const m = String(d.getMonth() + 1).padStart(2, '0'); const dd = String(d.getDate()).padStart(2, '0');
                        prevDateStr = `${y}-${m}-${dd}`;
                    }
                } catch (e) { return null; }
                const found = hotels.value.find(h => {
                    if (!h.startDate || !h.endDate) return false;
                    return (h.startDate <= prevDateStr && h.endDate > prevDateStr);
                });
                return found || null;
            });

            const currentEvents = computed(() => {
                if (itinerary.value && itinerary.value[currDayIdx.value]) {
                    return itinerary.value[currDayIdx.value].events || [];
                }
                return [];
            });
            
            const openEventModal = () => { isEditing.value=false; Object.assign(eventForm, { id: Date.now(), name: '', time: '10:00', category: 'spot', ticket: '', openTime: '', note: '', transportMode: 'transport', travelTime: '' }); showEventModal.value = true; };
            const editEvent = (evt) => { isEditing.value=true; Object.assign(eventForm, evt); showEventModal.value = true; };
            const saveEvent = () => { const dayEvents = itinerary.value[currDayIdx.value].events; if(isEditing.value) { const idx = dayEvents.findIndex(e => e.id === eventForm.id); if(idx!==-1) dayEvents[idx] = {...eventForm, transport: dayEvents[idx].transport}; } else dayEvents.push({...eventForm}); showEventModal.value = false; };
            const confirmDeleteEvent = () => { if(confirm("刪除行程?")) { const evts = itinerary.value[currDayIdx.value].events; const idx = evts.findIndex(e => e.id === eventForm.id); if(idx!==-1) evts.splice(idx,1); showEventModal.value=false; }};
            const addDay = () => { const d = new Date(itinerary.value[itinerary.value.length-1].date); d.setDate(d.getDate()+1); itinerary.value.push({date:d.toISOString().split('T')[0], events:[]}); };
            const deleteDay = (idx) => { if(itinerary.value.length>1 && confirm("刪除這一天?")) itinerary.value.splice(idx,1); };
            const editDayDate = (idx) => { const n = prompt("日期", itinerary.value[idx].date); if(n) itinerary.value[idx].date = n; };
            const openMap = (q) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q + ' 北海道')}`);
            const translateCat = (c) => ({'spot':'景點','food':'美食','hotel':'住宿','shopping':'購物','transport':'交通','other':'其他'}[c]||c);
            const getCatColor = (c) => ({'spot':'bg-blue-400', 'food':'bg-orange-400','transport':'bg-stone-500','shopping':'bg-pink-400','hotel':'bg-purple-400','other':'bg-gray-400'}[c]||'bg-stone-400');
            const getCatIcon = (c) => ({'spot':'fa-camera','food':'fa-utensils','transport':'fa-train','shopping':'fa-bag-shopping','hotel':'fa-bed','other':'fa-star'}[c]||'fa-circle');
            
            const openHotelModal = (isEdit, d=null) => { 
                if(isEdit&&d) Object.assign(hotelForm, d); 
                else Object.assign(hotelForm, { id:null, name:'', address:'', startDate:'', endDate:'', checkIn:'15:00', checkOut:'11:00', price:'', image:'' }); 
                showHotelModal.value = true; 
            };

            const handleHotelImg = (e) => { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=(e)=>hotelForm.image=e.target.result; r.readAsDataURL(f); }};
            const saveHotel = () => { if(hotelForm.name) { if(hotelForm.id) { const idx=hotels.value.findIndex(h=>h.id===hotelForm.id); if(idx!==-1) hotels.value[idx]={...hotelForm}; } else { hotels.value.push({...hotelForm, id: Date.now()}); } showHotelModal.value=false; }};
            const deleteHotel = () => { if(confirm('刪除?')) { const idx=hotels.value.findIndex(h=>h.id===hotelForm.id); hotels.value.splice(idx,1); showHotelModal.value=false; }};
            const calculateNights = (s, e) => {
                if(!s || !e) return 0;
                const diff = new Date(e) - new Date(s);
                return Math.max(0, Math.round(diff/(1000*60*60*24)));
            };

            const addMember = () => { if(newMemberName.value) { members.value.push({name:newMemberName.value, avatar:''}); newMemberName.value=''; showMemberModal.value=false; }};
            const deleteMember = (idx) => { if(confirm('刪除?')) members.value.splice(idx,1); };
            const updateMemberAvatar = (e, idx) => { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=(e)=>members.value[idx].avatar=e.target.result; r.readAsDataURL(f); }};
            const addTodo = () => { const t = prompt('待辦事項'); if(t) todoList.value.push({text:t, done:false}); };
            const deleteTodo = (idx) => todoList.value.splice(idx,1);
            const openItemModal = (t) => { itemFormType.value=t; Object.assign(itemForm, {name:'', price:'', note:'', image:''}); showItemModal.value=true; };
            const handleItemImg = (e) => { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=(e)=>itemForm.image=e.target.result; r.readAsDataURL(f); }};
            const saveItem = () => { if(itemForm.name) { if(itemFormType.value==='shopping') shoppingList.value.push({...itemForm}); else wishlist.value.push({...itemForm}); showItemModal.value=false; }};
            const deleteShopping = (idx) => { if(confirm('刪除?')) shoppingList.value.splice(idx,1); };
            const deleteWishlist = (idx) => { if(confirm('刪除?')) wishlist.value.splice(idx,1); };
            const openExpenseModal = () => { Object.assign(expForm, {amount:'', title:'', payer:members.value[0].name, method:'cash', isPublic:true, category:'food'}); showExpModal.value=true; };
            const saveExpense = () => { if(expForm.amount) { expenses.value.push({...expForm, amount:Number(expForm.amount)}); showExpModal.value=false; } };
            const deleteExpense = (idx) => { if(confirm('刪除?')) expenses.value.splice(idx,1); };
            const totalExpense = computed(() => expenses.value.reduce((acc, cur) => acc + cur.amount, 0));
            const totalByMethod = (m) => expenses.value.filter(e=>e.method===m).reduce((acc, cur) => acc + cur.amount, 0);

            return {
                user, login, currentTab, tabs, syncStatusClass, weather, members, newMemberName, addMember, deleteMember, updateMemberAvatar, showMemberModal,
                exchangeRate, exchangeInput, hotels, showHotelModal, hotelForm, openHotelModal, handleHotelImg, saveHotel, deleteHotel, calculateNights, 
                planType, todoList, addTodo, deleteTodo, shoppingList, wishlist, openItemModal, showItemModal, itemForm, itemFormType, handleItemImg, saveItem, deleteShopping, deleteWishlist,
                itinerary, currDayIdx, currentEvents, addDay, deleteDay, editDayDate, getWeekName, getDayDate, openEventModal, showEventModal, eventForm, saveEvent, editEvent, isEditing, confirmDeleteEvent, openMap, translateCat, getCatColor, getCatIcon, previousNightHotel,
                expenses, showExpModal, expForm, openExpenseModal, saveExpense, deleteExpense, totalExpense, totalByMethod,
                flights, showFlightModal, flightForm, openFlightModal, saveFlight, deleteFlightEdit, calculateDurationDisplay, isNextDay,
                // Transport related
                showTransportModal, transportForm, transportTypes, openTransportModal, saveTransport, deleteTransport, getTransportIcon
            };
        }
    }).mount('#app');
</script>
</body>
</html>
```

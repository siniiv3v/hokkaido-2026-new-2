
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hokkaido Trip</title>
    
    <!-- 核心函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 字體：圓體 (Zen Maru Gothic) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Tailwind 設定 (Muji Style) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Zen Maru Gothic"', '"Noto Sans TC"', 'sans-serif'] },
                    colors: {
                        muji: {
                            bg: '#F9F9F7',       // 米白背景
                            card: '#FFFFFF',     // 純白卡片
                            text: '#44403C',     // 深石灰
                            sub: '#78716C',      // 淺石灰
                            accent: '#8DA3C1',   // 雪藍
                            warm: '#E7E5E4',     // 暖灰線條
                        }
                    },
                    boxShadow: {
                        'soft': '0 10px 30px -10px rgba(68, 64, 60, 0.08)',
                        'float': '0 20px 40px -10px rgba(68, 64, 60, 0.12)',
                    },
                    spacing: { 'safe-top': 'env(safe-area-inset-top)', 'safe-bottom': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F9F9F7; color: #44403C; -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea { user-select: text; outline: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 玻璃擬態 header */
        .glass { background: rgba(249, 249, 247, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        
        /* 動畫 */
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

<div id="app" class="flex flex-col h-full relative">

    <!-- Header -->
    <header class="glass z-30 pt-safe-top border-b border-stone-200/50 absolute top-0 w-full shadow-sm flex flex-col">
        <!-- 標題 -->
        <div class="h-12 flex items-center justify-center shrink-0">
            <h1 class="text-xl font-bold tracking-widest flex items-center gap-2 text-muji-text">
                Hokkaido <i class="fa-regular fa-snowflake text-muji-accent text-2xl animate-pulse"></i>
            </h1>
        </div>
        <!-- 橫向 Tabs -->
        <nav class="flex w-full overflow-x-auto hide-scrollbar px-2 pb-0">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" 
                class="flex-1 min-w-[4rem] flex flex-col items-center justify-center pb-2 pt-1 gap-1 relative transition-colors group"
                :class="currentTab === tab.id ? 'text-muji-text' : 'text-stone-300 hover:text-stone-400'">
                <i :class="tab.icon" class="text-lg transition-transform duration-300" :class="currentTab === tab.id ? '-translate-y-0.5' : ''"></i>
                <span class="text-[10px] font-bold tracking-wide">{{ tab.name }}</span>
                <div class="absolute bottom-0 w-8 h-1 bg-muji-accent rounded-t-full transition-all duration-300" :class="currentTab === tab.id ? 'opacity-100 scale-100' : 'opacity-0 scale-0'"></div>
            </button>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto hide-scrollbar pt-28 pb-safe-bottom px-5 bg-muji-bg">
        
        <!-- ===== 1. 資訊 (Info) ===== -->
        <div v-if="currentTab === 'info'" class="fade-in space-y-6 pb-20">
            <!-- 天氣與匯率 -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gradient-to-br from-[#A5B4C4] to-[#8DA3C1] rounded-[2rem] p-5 text-white shadow-soft relative overflow-hidden group">
                    <div class="relative z-10">
                        <p class="text-[10px] font-medium opacity-80 uppercase tracking-widest">Weather</p>
                        <h3 class="text-3xl font-bold mt-2">-2°c</h3>
                        <div class="flex items-center gap-2 mt-2 opacity-90 text-sm"><i class="fa-solid fa-snowflake"></i> <span>Sapporo</span></div>
                    </div>
                    <i class="fa-solid fa-wind absolute -bottom-4 -right-4 text-8xl opacity-10"></i>
                </div>
                <div class="bg-white rounded-[2rem] p-5 shadow-soft relative border border-stone-50 flex flex-col justify-between">
                    <div>
                        <p class="text-[10px] text-stone-400 font-bold uppercase tracking-widest">Rate (HKD)</p>
                        <div class="flex items-baseline mt-1 border-b border-stone-100 pb-1">
                            <span class="text-stone-300 text-sm mr-1">¥</span>
                            <input type="number" v-model="exchangeInput" class="w-full bg-transparent font-bold text-xl text-stone-700 placeholder-stone-200">
                        </div>
                    </div>
                    <div class="text-right mt-2">
                        <span class="block text-2xl font-bold text-stone-700">${{ (exchangeInput * exchangeRate).toFixed(1) }}</span>
                    </div>
                </div>
            </div>
            <!-- 航班與住宿 (略簡化以節省篇幅，保留核心結構) -->
             <div class="bg-white rounded-[2rem] shadow-soft p-5 overflow-hidden relative">
                 <h2 class="text-sm font-bold text-muji-text mb-3">我的航班</h2>
                 <div v-for="(flight, idx) in flights" :key="idx" class="flex justify-between items-center border-b border-stone-100 pb-3 last:border-0 last:pb-0 mb-3 last:mb-0">
                     <div class="text-center"><span class="block text-xl font-bold">{{ flight.depCode }}</span><span class="text-[10px] text-stone-400">{{ flight.depTime }}</span></div>
                     <i class="fa-solid fa-plane text-stone-300"></i>
                     <div class="text-center"><span class="block text-xl font-bold">{{ flight.arrCode }}</span><span class="text-[10px] text-stone-400">{{ flight.arrTime }}</span></div>
                     <button @click="deleteFlight(idx)" class="text-stone-200 hover:text-red-400 ml-2"><i class="fa-solid fa-trash"></i></button>
                 </div>
                 <button @click="addFlight" class="w-full mt-2 py-2 text-xs text-stone-400 border border-dashed border-stone-200 rounded-xl">+ 新增航班</button>
             </div>
        </div>

        <!-- ===== 2. 準備 (Planning) - 更新版 ===== -->
        <div v-if="currentTab === 'planning'" class="fade-in space-y-6 pb-20">
            <!-- 子分頁切換 -->
            <div class="flex p-1 bg-stone-200/50 rounded-xl mb-4">
                <button @click="planType = 'todo'" :class="planType === 'todo' ? 'bg-white shadow-sm text-muji-text' : 'text-muji-sub'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all">待辦</button>
                <button @click="planType = 'shopping'" :class="planType === 'shopping' ? 'bg-white shadow-sm text-muji-text' : 'text-muji-sub'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all">購物</button>
                <button @click="planType = 'wishlist'" :class="planType === 'wishlist' ? 'bg-white shadow-sm text-muji-text' : 'text-muji-sub'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all">想去</button>
            </div>

            <!-- 1. 待辦列表 -->
            <div v-if="planType === 'todo'" class="space-y-3">
                <div v-for="(item, idx) in todoList" :key="idx" class="bg-white p-4 rounded-3xl shadow-soft flex items-center gap-3 active:scale-[0.98] transition-transform">
                    <button @click="item.done = !item.done" :class="item.done ? 'bg-muji-accent border-muji-accent' : 'border-stone-300'" class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors">
                        <i v-if="item.done" class="fa-solid fa-check text-white text-xs"></i>
                    </button>
                    <span :class="item.done ? 'text-stone-300 line-through' : 'text-muji-text'" class="flex-1 font-medium">{{ item.text }}</span>
                    <button @click="deleteTodo(idx)" class="text-stone-200 hover:text-red-400 p-2"><i class="fa-solid fa-trash-can"></i></button>
                </div>
                <button @click="addTodo" class="w-full py-3 rounded-2xl border-2 border-dashed border-stone-300 text-stone-400 font-bold hover:bg-white transition-colors">+ 新增待辦</button>
            </div>

            <!-- 2. 購物列表 -->
            <div v-if="planType === 'shopping'" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div v-for="(item, idx) in shoppingList" :key="idx" class="bg-white rounded-3xl shadow-soft overflow-hidden relative group">
                        <div class="aspect-square bg-stone-100 relative">
                            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                            <div v-else class="w-full h-full flex items-center justify-center text-stone-300"><i class="fa-solid fa-gift text-3xl"></i></div>
                            <button @click="deleteShopping(idx)" class="absolute top-2 right-2 w-8 h-8 bg-white/90 rounded-full text-red-400 shadow-sm flex items-center justify-center"><i class="fa-solid fa-trash text-xs"></i></button>
                        </div>
                        <div class="p-3">
                            <p class="font-bold text-sm truncate text-muji-text">{{ item.name }}</p>
                            <p class="text-xs text-stone-400 mt-1">¥{{ item.price }}</p>
                        </div>
                    </div>
                </div>
                <button @click="openItemModal('shopping')" class="fixed bottom-10 right-5 w-14 h-14 bg-stone-800 text-white rounded-[1.25rem] shadow-float flex items-center justify-center text-xl z-20 active:scale-90 transition-transform"><i class="fa-solid fa-camera"></i></button>
            </div>

            <!-- 3. 想去清單 (Wishlist) -->
            <div v-if="planType === 'wishlist'" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div v-for="(item, idx) in wishlist" :key="idx" class="bg-white rounded-3xl shadow-soft overflow-hidden relative group">
                        <div class="aspect-video bg-stone-100 relative">
                            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                            <div v-else class="w-full h-full flex items-center justify-center text-stone-300"><i class="fa-solid fa-location-dot text-3xl"></i></div>
                            <button @click="deleteWishlist(idx)" class="absolute top-2 right-2 w-8 h-8 bg-white/90 rounded-full text-red-400 shadow-sm flex items-center justify-center"><i class="fa-solid fa-trash text-xs"></i></button>
                        </div>
                        <div class="p-3">
                            <p class="font-bold text-sm truncate text-muji-text">{{ item.name }}</p>
                            <p class="text-xs text-stone-400 mt-1 truncate">{{ item.note || '無備註' }}</p>
                        </div>
                    </div>
                </div>
                <button @click="openItemModal('wishlist')" class="fixed bottom-10 right-5 w-14 h-14 bg-muji-accent text-white rounded-[1.25rem] shadow-float flex items-center justify-center text-xl z-20 active:scale-90 transition-transform"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>

        <!-- ===== 3. 行程 (Itinerary) ===== -->
        <div v-if="currentTab === 'itinerary'" class="fade-in pb-20">
            <!-- 日期 Scroll -->
            <div class="flex gap-3 overflow-x-auto hide-scrollbar mb-6 pb-2">
                <div v-for="(day, idx) in itinerary" :key="idx" @click="currDayIdx = idx"
                     :class="currDayIdx === idx ? 'bg-muji-text text-white shadow-lg transform -translate-y-1' : 'bg-white text-stone-400 border border-stone-100'"
                     class="flex-shrink-0 flex flex-col items-center justify-center w-[4.5rem] h-20 rounded-[1.25rem] transition-all duration-300 cursor-pointer">
                    <span class="text-[10px] opacity-80 uppercase tracking-widest">Day {{ idx+1 }}</span>
                    <span class="text-xl font-bold">{{ getDayDate(day.date) }}</span>
                </div>
                <button @click="addDay" class="flex-shrink-0 w-12 h-20 rounded-[1.25rem] border border-dashed border-stone-300 text-stone-400 flex items-center justify-center"><i class="fa-solid fa-plus"></i></button>
            </div>
            <!-- 行程列表 -->
            <div class="relative pl-4 space-y-6">
                <div class="absolute left-[19px] top-4 bottom-0 w-0.5 bg-stone-200 z-0"></div>
                <div v-for="(event, idx) in currentEvents" :key="event.id" class="relative z-10">
                    <div class="flex items-start group">
                        <div class="w-10 h-10 rounded-full bg-white border border-stone-100 shadow-sm flex items-center justify-center text-xs font-bold text-stone-500 z-20 shrink-0">{{ event.time }}</div>
                        <div class="ml-4 flex-1 bg-white rounded-[1.5rem] p-5 shadow-soft active:scale-[0.98] transition-transform border border-stone-50" @click="editEvent(event)">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="text-[10px] bg-stone-100 text-stone-500 px-2 py-0.5 rounded-full mb-1 inline-block">{{ translateCat(event.category) }}</span>
                                    <h3 class="font-bold text-lg text-muji-text">{{ event.name }}</h3>
                                </div>
                                <button @click.stop="openMap(event.name)" class="w-8 h-8 rounded-full bg-stone-800 text-white flex items-center justify-center shadow-md"><i class="fa-solid fa-location-arrow text-xs"></i></button>
                            </div>
                            <p v-if="event.note" class="text-xs text-stone-400 mt-2 bg-stone-50 p-2 rounded-xl">{{ event.note }}</p>
                        </div>
                    </div>
                </div>
                <button @click="openEventModal" class="fixed bottom-10 right-5 w-14 h-14 bg-muji-text text-white rounded-[1.25rem] shadow-float flex items-center justify-center text-xl z-20 active:scale-90 transition-transform"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>

        <!-- ===== 4. 記帳 (Accounting) ===== -->
        <div v-if="currentTab === 'accounting'" class="fade-in space-y-6 pb-20">
            <div class="bg-stone-800 text-[#F9F9F7] rounded-[2rem] p-6 shadow-float relative overflow-hidden">
                <p class="text-xs text-stone-400 uppercase tracking-widest mb-1">Total Spent</p>
                <h2 class="text-4xl font-bold font-sans">¥ {{ totalExpense.toLocaleString() }}</h2>
                <div class="mt-6 flex gap-3">
                    <div class="bg-white/10 backdrop-blur rounded-xl px-4 py-2 border border-white/5 flex-1"><p class="text-[10px] text-stone-300">CASH</p><p class="font-bold">¥ {{ totalByMethod('cash').toLocaleString() }}</p></div>
                    <div class="bg-white/10 backdrop-blur rounded-xl px-4 py-2 border border-white/5 flex-1"><p class="text-[10px] text-stone-300">CARD</p><p class="font-bold">¥ {{ totalByMethod('card').toLocaleString() }}</p></div>
                </div>
            </div>
            <div class="space-y-3">
                <div v-for="(exp, idx) in expenses" :key="idx" class="bg-white p-4 rounded-3xl shadow-soft flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div :class="getCatColor(exp.category)" class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm"><i :class="getCatIcon(exp.category)"></i></div>
                        <div><p class="font-bold text-muji-text text-sm">{{ exp.title }}</p><p class="text-xs text-stone-400">{{ exp.payer }} 付款 <span v-if="exp.isPublic" class="text-purple-500 bg-purple-50 px-1 rounded ml-1">公費</span></p></div>
                    </div>
                    <div class="text-right"><p class="font-bold text-muji-text">¥{{ Number(exp.amount).toLocaleString() }}</p><button @click="deleteExpense(idx)" class="text-stone-200 text-xs mt-1 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></div>
                </div>
            </div>
            <button @click="openExpenseModal" class="fixed bottom-10 right-5 w-14 h-14 bg-muji-text text-white rounded-[1.25rem] shadow-float flex items-center justify-center text-xl z-20 active:scale-90 transition-transform"><i class="fa-solid fa-pen"></i></button>
        </div>

        <!-- ===== 5. 成員 (Members) - 更新版 ===== -->
        <div v-if="currentTab === 'members'" class="fade-in pb-20">
            <h2 class="text-lg font-bold text-muji-text mb-4">旅伴名單</h2>
            <div class="grid grid-cols-2 gap-4">
                <div v-for="(m, idx) in members" :key="idx" class="bg-white p-5 rounded-[1.5rem] shadow-soft flex flex-col items-center relative group">
                    <!-- 頭像上傳區 -->
                    <label class="w-16 h-16 rounded-full bg-stone-100 mb-3 overflow-hidden relative cursor-pointer hover:opacity-80 transition-opacity">
                         <img v-if="m.avatar" :src="m.avatar" class="w-full h-full object-cover">
                         <div v-else class="w-full h-full flex items-center justify-center text-stone-300"><i class="fa-solid fa-camera"></i></div>
                         <input type="file" accept="image/*" @change="(e) => updateMemberAvatar(e, idx)" class="hidden">
                    </label>
                    <span class="font-bold text-muji-text">{{ m.name }}</span>
                    <button @click="deleteMember(idx)" class="absolute top-2 right-2 text-stone-200 hover:text-red-400"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <!-- 新增成員 -->
                <div class="bg-stone-100/50 border-2 border-dashed border-stone-300 rounded-[1.5rem] p-5 flex flex-col items-center justify-center gap-2">
                    <input v-model="newMemberName" placeholder="名字" class="bg-transparent text-center w-full font-bold text-muji-text placeholder-stone-400 text-sm">
                    <button @click="addMember" class="w-8 h-8 rounded-full bg-muji-text text-white flex items-center justify-center"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
        </div>

    </main>

    <!-- Modals -->
    
    <!-- Item Modal (Shopping & Wishlist) -->
    <div v-if="showItemModal" class="fixed inset-0 z-[60] flex items-end justify-center bg-stone-900/30 backdrop-blur-sm" @click.self="showItemModal=false">
        <div class="bg-white w-full rounded-t-[2rem] p-6 slide-up pb-safe-bottom">
            <h3 class="text-center font-bold text-lg mb-6">{{ itemFormType === 'shopping' ? '新增購物清單' : '新增想去景點' }}</h3>
            <label class="block w-full h-32 bg-stone-50 rounded-2xl border-2 border-dashed border-stone-200 mb-4 flex items-center justify-center relative overflow-hidden">
                <img v-if="itemForm.image" :src="itemForm.image" class="w-full h-full object-cover">
                <div v-else class="text-stone-400 flex flex-col items-center"><i class="fa-solid fa-camera mb-1"></i><span class="text-xs">上傳照片</span></div>
                <input type="file" accept="image/*" @change="handleItemImg" class="hidden">
            </label>
            <input v-model="itemForm.name" placeholder="名稱" class="w-full p-4 bg-stone-50 rounded-2xl mb-3 font-bold">
            <input v-if="itemFormType==='shopping'" type="number" v-model="itemForm.price" placeholder="價格 (JPY)" class="w-full p-4 bg-stone-50 rounded-2xl mb-6">
            <input v-else v-model="itemForm.note" placeholder="備註 / 說明" class="w-full p-4 bg-stone-50 rounded-2xl mb-6">
            <button @click="saveItem" class="w-full bg-stone-800 text-white py-4 rounded-2xl font-bold shadow-lg">加入</button>
        </div>
    </div>

    <!-- Expense Modal -->
    <div v-if="showExpModal" class="fixed inset-0 z-[60] flex items-end justify-center bg-stone-900/30 backdrop-blur-sm" @click.self="showExpModal=false">
        <div class="bg-white w-full rounded-t-[2rem] p-6 slide-up pb-safe-bottom">
            <h3 class="text-center font-bold text-lg mb-4">記一筆</h3>
            <div class="bg-stone-100 rounded-2xl p-4 mb-4 text-center">
                <input type="number" inputmode="decimal" v-model="expForm.amount" placeholder="0" class="bg-transparent text-4xl font-bold text-center w-full text-muji-text">
                <span class="text-xs text-stone-400">JPY</span>
            </div>
            <input v-model="expForm.title" placeholder="項目" class="w-full p-4 bg-stone-50 rounded-2xl mb-3 font-bold">
            <div class="flex gap-2 overflow-x-auto hide-scrollbar mb-4">
                <button v-for="m in members" :key="m.name" @click="expForm.payer=m.name" 
                    :class="expForm.payer===m.name ? 'bg-stone-800 text-white' : 'bg-stone-100 text-stone-400'"
                    class="px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-colors">{{ m.name }}</button>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button @click="expForm.method='cash'" :class="expForm.method==='cash'?'bg-stone-200 ring-2 ring-stone-400':'bg-stone-50'" class="py-3 rounded-xl text-sm font-bold text-stone-600">現金</button>
                <button @click="expForm.method='card'" :class="expForm.method==='card'?'bg-blue-100 ring-2 ring-blue-300 text-blue-600':'bg-stone-50'" class="py-3 rounded-xl text-sm font-bold text-stone-400">信用卡</button>
            </div>
            <div class="flex items-center justify-between p-4 bg-stone-50 rounded-2xl mb-6">
                <span class="font-bold text-stone-600 text-sm">公費 (大家平分)</span>
                <div @click="expForm.isPublic=!expForm.isPublic" :class="expForm.isPublic?'bg-green-400':'bg-stone-300'" class="w-10 h-6 rounded-full relative transition-colors"><div :class="expForm.isPublic?'left-5':'left-1'" class="absolute top-1 w-4 h-4 bg-white rounded-full transition-all"></div></div>
            </div>
            <button @click="saveExpense" class="w-full bg-stone-800 text-white py-4 rounded-2xl font-bold shadow-lg">儲存</button>
        </div>
    </div>

    <!-- Event Modal -->
    <div v-if="showEventModal" class="fixed inset-0 z-[60] flex items-end justify-center bg-stone-900/30 backdrop-blur-sm" @click.self="showEventModal=false">
        <div class="bg-white w-full rounded-t-[2rem] p-6 slide-up pb-safe-bottom">
            <h3 class="text-center font-bold text-lg mb-6">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
            <div class="space-y-4">
                 <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1">
                    <button v-for="c in ['spot','food','shopping','hotel','transport']" @click="eventForm.category=c" :class="eventForm.category===c?'bg-stone-800 text-white':'bg-stone-100 text-stone-400'" class="px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap">{{ translateCat(c) }}</button>
                </div>
                <input v-model="eventForm.name" placeholder="名稱" class="w-full p-4 bg-stone-50 rounded-2xl font-bold">
                <div class="flex gap-2">
                    <input type="time" v-model="eventForm.time" class="w-1/3 p-4 bg-stone-50 rounded-2xl text-center font-bold text-stone-600">
                    <input v-model="eventForm.ticket" placeholder="費用/門票" class="flex-1 p-4 bg-stone-50 rounded-2xl text-sm">
                </div>
                <textarea v-model="eventForm.note" placeholder="備註" class="w-full p-4 bg-stone-50 rounded-2xl h-24 text-sm text-stone-600 resize-none"></textarea>
            </div>
            <div class="flex gap-3 mt-6">
                 <button v-if="isEditing" @click="deleteEvent" class="w-14 bg-red-50 text-red-400 rounded-2xl flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>
                 <button @click="saveEvent" class="flex-1 bg-stone-800 text-white py-4 rounded-2xl font-bold shadow-lg">完成</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, reactive, onMounted, watch } = Vue;

    createApp({
        setup() {
            // State
            const currentTab = ref('info');
            const tabs = [
                { id: 'info', name: '資訊', icon: 'fa-solid fa-info' },
                { id: 'planning', name: '準備', icon: 'fa-solid fa-bag-shopping' },
                { id: 'itinerary', name: '行程', icon: 'fa-regular fa-map' },
                { id: 'accounting', name: '記帳', icon: 'fa-solid fa-wallet' },
                { id: 'members', name: '成員', icon: 'fa-solid fa-user-group' }
            ];

            // Info
            const exchangeRate = ref(0.052);
            const exchangeInput = ref(1000);
            const flights = ref([]);
            
            // Members
            const members = ref([{name:'我', avatar:''}]);
            const newMemberName = ref('');

            // Planning
            const planType = ref('todo');
            const todoList = ref([{text:'辦簽證', done:false}]);
            const shoppingList = ref([]);
            const wishlist = ref([]);
            
            // Itinerary
            const itinerary = ref([{date:'2025-01-23', events:[]}]);
            const currDayIdx = ref(0);
            
            // Expenses
            const expenses = ref([]);

            // Modals & Forms
            const showItemModal = ref(false);
            const itemFormType = ref('shopping'); // shopping or wishlist
            const itemForm = reactive({name:'', price:'', note:'', image:''});
            
            const showExpModal = ref(false);
            const expForm = reactive({amount:'', title:'', payer:'我', method:'cash', isPublic:true, category:'food'});
            
            const showEventModal = ref(false);
            const eventForm = reactive({id:null, name:'', time:'10:00', category:'spot', ticket:'', note:'', nextTravelTime:'15 min'});
            const isEditing = ref(false);

            // Init & Persist
            onMounted(() => {
                const saved = localStorage.getItem('hokkaido_v5');
                if(saved) {
                    const data = JSON.parse(saved);
                    members.value = data.members || members.value;
                    todoList.value = data.todoList || todoList.value;
                    shoppingList.value = data.shoppingList || [];
                    wishlist.value = data.wishlist || [];
                    itinerary.value = data.itinerary || itinerary.value;
                    expenses.value = data.expenses || [];
                    flights.value = data.flights || [];
                }
                if(flights.value.length===0) flights.value.push({type:'去程', depCode:'HKG', arrCode:'CTS', depTime:'09:00', arrTime:'14:30', duration:'5h30m'});
            });

            watch([members, todoList, shoppingList, wishlist, itinerary, expenses, flights], () => {
                localStorage.setItem('hokkaido_v5', JSON.stringify({
                    members: members.value, todoList: todoList.value, shoppingList: shoppingList.value, wishlist: wishlist.value,
                    itinerary: itinerary.value, expenses: expenses.value, flights: flights.value
                }));
            }, { deep: true });

            // Methods: Info
            const addFlight = () => flights.value.push({type:'回程', depCode:'CTS', arrCode:'HKG', depTime:'16:00', arrTime:'20:30', duration:'5h30m'});
            const deleteFlight = (idx) => flights.value.splice(idx,1);

            // Methods: Members
            const addMember = () => { if(newMemberName.value) { members.value.push({name:newMemberName.value, avatar:''}); newMemberName.value=''; } };
            const deleteMember = (idx) => { if(confirm('刪除?')) members.value.splice(idx,1); };
            const updateMemberAvatar = (e, idx) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => members.value[idx].avatar = e.target.result;
                    reader.readAsDataURL(file);
                }
            };

            // Methods: Planning
            const addTodo = () => { const t = prompt('待辦事項'); if(t) todoList.value.push({text:t, done:false}); };
            const deleteTodo = (idx) => todoList.value.splice(idx,1);
            
            const openItemModal = (type) => { itemFormType.value=type; Object.assign(itemForm, {name:'', price:'', note:'', image:''}); showItemModal.value=true; };
            const handleItemImg = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => itemForm.image = e.target.result;
                    reader.readAsDataURL(file);
                }
            };
            const saveItem = () => {
                if(itemForm.name) {
                    if(itemFormType.value==='shopping') shoppingList.value.push({...itemForm});
                    else wishlist.value.push({...itemForm});
                    showItemModal.value=false;
                }
            };
            const deleteShopping = (idx) => { if(confirm('刪除?')) shoppingList.value.splice(idx,1); };
            const deleteWishlist = (idx) => { if(confirm('刪除?')) wishlist.value.splice(idx,1); };

            // Methods: Itinerary
            const currentEvents = computed(() => itinerary.value[currDayIdx.value].events.sort((a,b)=>a.time.localeCompare(b.time)));
            const addDay = () => { const d = new Date(itinerary.value[itinerary.value.length-1].date); d.setDate(d.getDate()+1); itinerary.value.push({date:d.toISOString().split('T')[0], events:[]}); };
            const getDayDate = (d) => { const date = new Date(d); return `${date.getMonth()+1}/${date.getDate()}`; };
            const openEventModal = () => { isEditing.value=false; Object.assign(eventForm, {id:Date.now(), name:'', time:'10:00', category:'spot', ticket:'', note:'', nextTravelTime:'15 min'}); showEventModal.value=true; };
            const editEvent = (evt) => { isEditing.value=true; Object.assign(eventForm, evt); showEventModal.value=true; };
            const saveEvent = () => {
                const evts = itinerary.value[currDayIdx.value].events;
                if(isEditing.value) { const idx=evts.findIndex(e=>e.id===eventForm.id); if(idx!==-1) evts[idx]={...eventForm}; }
                else evts.push({...eventForm});
                showEventModal.value=false;
            };
            const deleteEvent = () => {
                const evts = itinerary.value[currDayIdx.value].events;
                const idx=evts.findIndex(e=>e.id===eventForm.id); evts.splice(idx,1); showEventModal.value=false;
            };
            const openMap = (q) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q+' 北海道')}`, '_blank');
            const translateCat = (c) => ({'spot':'景點','food':'美食','hotel':'住宿','shopping':'購物','transport':'交通'}[c]||c);

            // Methods: Expenses
            const openExpenseModal = () => { Object.assign(expForm, {amount:'', title:'', payer:members.value[0].name, method:'cash', isPublic:true, category:'food'}); showExpModal.value=true; };
            const saveExpense = () => { if(expForm.amount) { expenses.value.push({...expForm, amount:Number(expForm.amount)}); showExpModal.value=false; } };
            const deleteExpense = (idx) => { if(confirm('刪除?')) expenses.value.splice(idx,1); };
            const totalExpense = computed(() => expenses.value.reduce((acc, cur) => acc + cur.amount, 0));
            const totalByMethod = (m) => expenses.value.filter(e=>e.method===m).reduce((acc, cur) => acc + cur.amount, 0);
            const getCatColor = (c) => ({'food':'bg-orange-400','transport':'bg-blue-400','shopping':'bg-pink-400','hotel':'bg-purple-400'}[c]||'bg-stone-400');
            const getCatIcon = (c) => ({'food':'fa-utensils','transport':'fa-train','shopping':'fa-bag-shopping','hotel':'fa-bed'}[c]||'fa-star');

            return {
                currentTab, tabs, members, newMemberName, addMember, deleteMember, updateMemberAvatar,
                exchangeRate, exchangeInput, flights, addFlight, deleteFlight,
                planType, todoList, addTodo, deleteTodo, shoppingList, wishlist, openItemModal, showItemModal, itemForm, itemFormType, handleItemImg, saveItem, deleteShopping, deleteWishlist,
                itinerary, currDayIdx, currentEvents, addDay, getDayDate, openEventModal, showEventModal, eventForm, saveEvent, editEvent, isEditing, deleteEvent, openMap, translateCat,
                expenses, showExpModal, expForm, openExpenseModal, saveExpense, deleteExpense, totalExpense, totalByMethod, getCatColor, getCatIcon
            };
        }
    }).mount('#app');
</script>
</body>
</html>
```
